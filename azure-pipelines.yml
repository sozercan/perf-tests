trigger: none

variables:
  GOBIN: "$(GOPATH)/bin" # Go binaries path
  GOROOT: "/usr/local/go1.12" # Go installation path
  GOPATH: "$(system.defaultWorkingDirectory)/gopath" # Go workspace path
  modulePath: "$(GOPATH)/src/k8s.io/perf-tests" # Path to the module's code

pool:
  vmImage: "ubuntu-latest"

steps:
  - script: |
      mkdir -p '$(GOBIN)'
      mkdir -p '$(GOPATH)/pkg'
      mkdir -p '$(modulePath)'
      shopt -s extglob
      mv !(gopath) '$(modulePath)'
      echo '##vso[task.prependpath]$(GOBIN)'
      echo '##vso[task.prependpath]$(GOROOT)/bin'
    displayName: "Set up the Go workspace"

  - script: |
      curl -LO https://github.com/Azure/aks-engine/releases/download/v${AKS_ENGINE_VERSION}/aks-engine-v${AKS_ENGINE_VERSION}-linux-amd64.zip
      unzip aks-engine-v${AKS_ENGINE_VERSION}-linux-amd64.zip
      chmod +x aks-engine-v${AKS_ENGINE_VERSION}-linux-amd64/aks-engine
      sudo mv aks-engine-v${AKS_ENGINE_VERSION}-linux-amd64/aks-engine /usr/local/bin/
    displayName: "Download aks-engine"

  - script: envsubst < definition.json > cluster.json
    workingDirectory: "$(modulePath)"
    displayName: "Build apimodel"
    env:
      CLIENT_SECRET: $(AZURE_CLIENT_SECRET)

  - script: aks-engine deploy --api-model cluster.json --location ${AZURE_LOCATION} --subscription-id ${AZURE_SUBSCRIPTION_ID} --force-overwrite --client-id ${AZURE_CLIENT_ID} --client-secret ${CLIENT_SECRET}
    displayName: "Deploy Azure cluster"
    workingDirectory: "$(modulePath)"
    env:
      CLIENT_SECRET: $(AZURE_CLIENT_SECRET)

  - script: |
      mkdir -p /home/vsts/.kube
      cp _output/${AZURE_CLUSTER_NAME}/kubeconfig/kubeconfig.${AZURE_LOCATION}.json /home/vsts/.kube/config
    workingDirectory: "$(modulePath)"
    displayName: "copy kubeconfig"

  - script: go get -d ./...
    workingDirectory: "$(modulePath)"
    displayName: "go get dependencies"

  - script: ./run-e2e.sh cluster-loader2 --nodes=1 --provider=local --report-dir=_artifacts --testconfig=testing/node-throughput/config.yaml
    workingDirectory: "$(modulePath)"
    displayName: "run node throughput test"

  - script: |
      az login -t microsoft.com --service-principal -u ${AZURE_CLIENT_ID} -p ${CLIENT_SECRET}
      az delete -n ${AZURE_CLUSTER_NAME} --subscription ${AZURE_SUBSCRIPTION_ID}
    displayName: "teardown cluster"
    env:
      CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
