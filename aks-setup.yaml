steps:
  - script: |
      mkdir -p '$(GOBIN)'
      mkdir -p '$(GOPATH)/pkg'
      mkdir -p '$(modulePath)'
      shopt -s extglob
      cp -rf $(system.defaultWorkingDirectory)/* $(modulePath)
      echo '##vso[task.prependpath]$(GOBIN)'
      echo '##vso[task.prependpath]$(GOROOT)/bin'
    displayName: "Set up the Go workspace"

  - script: go get -d ./...
    workingDirectory: "$(modulePath)"
    displayName: "Get dependencies"

  - script: echo "##vso[task.setvariable variable=AZURE_CLUSTER_NAME]load-e2e-$(openssl rand -hex 6)"
    displayName: "Set cluster name"

  - script: |
      echo "##vso[task.setvariable variable=AZURE_ADMIN_USERNAME]$USER"
      echo -e 'y\n' | ssh-keygen -f ~/.ssh/$(AZURE_CLUSTER_NAME) -t rsa -N ''
      echo "##vso[task.setvariable variable=AZURE_SSH_KEY]$(cat ~/.ssh/$(AZURE_CLUSTER_NAME).pub)"
      echo "##vso[task.setvariable variable=LOCAL_SSH_KEY]$HOME/.ssh/$(AZURE_CLUSTER_NAME)"
    displayName: "Generate SSH key"

  - script: |
      az group create -n ${AZURE_CLUSTER_NAME} -l ${AZURE_LOCATION}
      az aks create -g ${AZURE_CLUSTER_NAME} -n ${AZURE_CLUSTER_NAME} --subscription ${AZURE_SUBSCRIPTION_ID} --node-count ${AGENT_POOL_COUNT} --kubernetes-version ${AKS_KUBERNETES_VERSION} --node-vm-size Standard_DS2_v2 --location ${AZURE_LOCATION} --service-principal ${AZURE_CLIENT_ID} --client-secret ${CLIENT_SECRET} --admin-username ${AZURE_ADMIN_USERNAME} --ssh-key-value ${LOCAL_SSH_KEY}.pub
      az aks get-credentials -n ${AZURE_CLUSTER_NAME} -g ${AZURE_CLUSTER_NAME}
      cp /home/azureuser/.kube/config $(modulePath)/kubeconfig.json
    displayName: "Deploy AKS cluster"
    workingDirectory: "$(modulePath)"
    env:
      CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
