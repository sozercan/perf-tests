steps:
  - task: PublishTestResults@2
    displayName: Publish Test Results
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: $(modulePath)/clusterloader2/_artifacts/junit.xml
    condition: succeededOrFailed()

  - script: |
      cd clusterloader2/_artifacts
      # rename : to -
      for f in *:*; do mv -v "$f" $(echo "$f" | tr ':' '-'); done
      # convert to csv
      for f in *.json ; do json2csv --header-style=slash --path=/100 "$f" > "${f%.json}.csv" ; done
      mkdir -p $(Build.ArtifactStagingDirectory)/${POD_COUNT}
      cp * $(Build.ArtifactStagingDirectory)/${POD_COUNT}
    workingDirectory: "$(modulePath)"
    displayName: Copy artifacts
    condition: succeededOrFailed()

  - task: PublishPipelineArtifact@1
    displayName: Save artifacts
    condition: succeededOrFailed()
    inputs:
      artifactName: drop-${POD_COUNT}
      targetPath: $(Build.ArtifactStagingDirectory)

  - script: |
      rm ${LOCAL_SSH_KEY}*
      az login -t microsoft.com --service-principal -u ${AZURE_CLIENT_ID} -p ${CLIENT_SECRET}
      az group delete -n ${AZURE_CLUSTER_NAME} --subscription ${AZURE_SUBSCRIPTION_ID} --yes --no-wait
    displayName: "Teardown cluster"
    condition: always()
    env:
      CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
